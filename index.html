<!DOCTYPE html>
<html>

<head>
    <title>IS-Map</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="./assets/css/ol.css" />
    <link rel="stylesheet" type="text/css" href="./assets/css/main.css" />
</head>

<body>
    <div id="map-container">
        <div id="map" class="map"></div>
        <div class="tools">
            <div id="search">
                <div class="col-md-6 col-md-offset-3">
                    <input type="text" name="" id="place" class="form-control" value="" required="required" pattern="" title="">
                </div>
            </div>
        </div>
    </div>
    <div id="debug">
        <span id="message"></span>
        <span id="info"></span>
        <form class="form-inline">
            <label>Geometry type &nbsp;</label>
            <select id="type">
                <option value="Polygon">Polygon</option>
                <option value="Point">Point</option>
                <option value="LineString">LineString</option>
            </select>
        </form>
    </div>
    <script type="text/javascript" src="./assets/js/islab-maps.js"></script>
    <script type="text/javascript" src="./assets/js/route.js"></script>
    <script type="text/javascript" src="./assets/js/maps.js"></script>
    <script type="text/javascript">
    var app = window.app;
    app.default_routing_start = [794.875,448.75]; // [141.375,789.125];
    app.vector_direction = null;

    var extent = [0, 0, 1024, 968];
    var router = [];
    var path = [];

    var projection = new ol.proj.Projection({
        code: 'xkcd-image',
        // code: 'EPSG:4326',
        units: 'pixels',
        extent: extent,
        axisOrientation: 'ne'
    });

    var vector = new ol.layer.Vector({
        source: new ol.source.Vector({
            url: 'assets/data.geojson',
            format: new ol.format.GeoJSON(),
            wrapX: false
        }),
        style: new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'rgba(255, 255, 255, 0.1)'
            }),
            stroke: new ol.style.Stroke({
                color: '#319FD3',
                width: 0.5
            })
        })
    });

    var select = new ol.interaction.Select({
        wrapX: false,
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: '#f00',
            width: 1
          }),
          fill: new ol.style.Fill({
            color: 'rgba(255,0,0,0.1)'
          })
        })
    });

    var map = new ol.Map({
        interactions: ol.interaction.defaults().extend([select]),
        layers: [
            new ol.layer.Image({
                source: new ol.source.ImageStatic({
                    attributions: [
                        new ol.Attribution({
                            html: 'ISLab '
                        })
                    ],
                    url: './assets/images/kcnc_bando.jpg',
                    projection: projection,
                    imageExtent: extent
                })
            }),
            vector
        ],
        controls: ol.control.defaults({
            attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
                collapsible: false
            })
        }),
        target: 'map',
        view: new ol.View({
            projection: projection,
            center: ol.extent.getCenter(extent),
            zoom: 2.5,
            maxZoom: 4,
            rotation: 0
        })
    });

    map.on('click', function(e) {
        // prompt('(x, y) = ', e.coordinate)
        //console.log('Click point => (' + e.coordinate.toString() + ')')
        document.getElementById('message').innerHTML = '(x, y) = ' + e.coordinate.toString();
        // console.log(map.getInteractions().getArray())
    });

    var featureOverlay = new ol.layer.Vector({
        source: new ol.source.Vector(),
        map: map,
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: '#f00',
                width: 1
            }),
            fill: new ol.style.Fill({
                color: 'rgba(255,0,0,0.1)'
            })
        })
    });

    var highlight;
    app.direction_input = {
        from: {
            id: 'start_point',
            geoloc: app.default_routing_start
        },
        to: null
    };
    var addDirectionInput = function(point) {
        if (!app.direction_input) app.direction_input = {};
        
        if (app.direction_input.from == null) app.direction_input.from = point;
        else if (app.direction_input.to == null) app.direction_input.to = point;
        else {
            app.direction_input = {
                from: point,
                to: null
            }
        }

        if (app.debug) document.getElementById('info').innerHTML = JSON.stringify(app.direction_input);

        if (app.direction_input.from != null && app.direction_input.to != null) {
            var direction = app.getDirection(app.direction_input);

            console.log('  ~> ', JSON.stringify( [direction]))

            // Start draw
            map.removeLayer(app.vector_direction); // Remove old 
            var vectorSource = new ol.source.Vector();
            vectorSource.addFeature(new ol.Feature(
                new ol.geom.MultiLineString([ direction ])
            ));
            app.vector_direction = new ol.layer.Vector({
                source: vectorSource,
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#f00',
                        width: 3
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(255,0,0,1)'
                    })
                })
            });
            map.addLayer(app.vector_direction);
        }
    }

    // Get block information    
    var displayFeatureInfo = function(pixel) {
        var feature = map.forEachFeatureAtPixel(pixel, function(feature) {
            return feature;
        });

        var info = document.getElementById('place');
        if (feature) {
            var point = feature.getId() + ': (' + feature.get('gateway') + ')';
            info.value = point;
            addDirectionInput({
                id: feature.getId(),
                geoloc: feature.get('gateway'),
                information: feature.get('information')
            });
        } else {
            info.value = '&nbsp;';
        }

        if (feature !== highlight) {
            if (highlight) {
                featureOverlay.getSource().removeFeature(highlight);
            }
            if (feature) {
                featureOverlay.getSource().addFeature(feature);
            }
            highlight = feature;
        }

    };

    /**
     * Hover to building block
     */
    map.on('pointermove', function(evt) {
        if (evt.dragging) {
            return;
        }
        // var pixel = map.getEventPixel(evt.originalEvent);
        // displayFeatureInfo(pixel);
    });

    /**
     * Click to building block
     */
    map.on('click', function(evt) {
        displayFeatureInfo(evt.pixel);
    });

    // ===========================
    // Debug tools

    var features = new ol.Collection();
    var featureOverlay = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: features
        }),
        style: new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'rgba(255, 255, 255, 0.2)'
            }),
            stroke: new ol.style.Stroke({
                color: '#ffcc33',
                width: 2
            }),
            image: new ol.style.Circle({
                radius: 7,
                fill: new ol.style.Fill({
                    color: '#ffcc33'
                })
            })
        })
    });
    featureOverlay.setMap(map);

    var modify = new ol.interaction.Modify({
        features: features,
        deleteCondition: function(event) {
            return ol.events.condition.shiftKeyOnly(event) &&
                ol.events.condition.singleClick(event);
        }
    });
    map.addInteraction(modify);

    var draw; // global so we can remove it later
    var typeSelect = document.getElementById('type');
    function addInteraction() {
        draw = new ol.interaction.Draw({
            features: features,
            type: /** @type {ol.geom.GeometryType} */ (typeSelect.value)
        });

        draw.on('drawend', function(e) {
            var data = app.getBlockPoint(e);

            var result = {
                name: name,
                points: data
            };

            // Tools to get router 
            if (typeSelect.value == 'LineString') {
                if (data && data.length >= 2) {
                    // Generator path 
                    app.arrayPointToRouterGeneratorTools(data);
                }
            }

            if (typeSelect.value == 'Polygon') {
                console.info(JSON.stringify(data));
            }
        });

        map.addInteraction(draw);
    }

    /**
     * Handle change event.
     */
    typeSelect.onchange = function() {
        map.removeInteraction(draw);
        addInteraction();
    };

    // addInteraction();
    </script>
</body>

</html>
